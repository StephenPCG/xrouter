# 设计思路

路由器上要安装很多工具，配置分散，需要记忆一堆东西，管理也麻烦。但实际上日常维护所涉及到的文件、命令都比较固定。因此创建该项目，核心思路：

* 尽量将配置集中到一起，通过集中的配置文件进行配置，由脚本将状态同步到系统中。主要包括网络接口（interface）、路由（route table/rule）、防火墙规则（nftables）等。
* 一些系统不自带、但常用的工具，通过 podman 容器安装，避免“污染”系统。

之前使用过一段时间 vyos，vyos 本身设计的很好，但侧重于企业级路由，对于家用路由有点太重。vyos 有一套配置系统，所有配置都通过统一的配置机制来管理，但这有些过于“极端”，失去了很多灵活性。

例如，我需要创建一些路由表（route table），每个表中可能有数千个 cidr，直接使用 `ip route add $cidr table` 可以非常快的插入数千甚至数万条记录，在 vyos 中，一方面没有提供相应的功能（其使用 nftables 创建 set，再对命中 set 的包打 fwmark，然后再用 ip rule 控制路由），当有数千条甚至数万行配置是，每次提交配置、检查 diff 都会非常慢。

本项目使用稍微折中的方案，我们并不追求配置语言的一致性，之需要将配置文件集中在一起即可。甚至许多配置文件可以直接用工具原始的语言，但统一放在一起，再 symlink 到系统中。

## 基本操作

日常操作本质上包括这样一些步骤：

* 修改集中管理的配置文件
* 将配置文件应用到系统中（可能是copy/symlink到系统中，可能是通过模板生成新的文件更新到系统中）
* 让系统应用新的配置文件（如重启服务、执行某个命令等）

常用命令示意：

```sh
# setup 会先同步一次配置文件，再执行 reload
gw setup interfaces|route|...

# 不加任何参数，表示对所有 gw 命令能控制的东西都进行相应的操作
gw setup
```
